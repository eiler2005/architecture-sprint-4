# Архитектурное решение по логированию

## Цели и задачи
Основная цель логирования — упростить разбор ошибок и нестандартных ситуаций, минимизировать нагрузку на поддержку и повысить прозрачность работы системы. Для этого необходимо:
1. Собрать единый центр логирования.
2. Определить, какие данные необходимо логировать на каждом уровне системы.
3. Обеспечить безопасное хранение и доступ к логам.
4. Внедрить механизм анализа и алертинга по ключевым метрикам.

---

# Предлагаемое решение

Решение по логированию будет состоять из нескольких уровней:
1) Сбор логов ОС и процессов с серверов
2) Сбор логов о бизнес событиях (создана новая заявка, изменение статусов и тп)

## Ключевые требования к бизнес событиям:
1. Каждая запись лога о бизнес событии должна содержать уникальный в рамках всей системы идентификатор бизнес объекта (номер заказа, id клиента и т.п.)
2. Каждое юизнес событие должно иметь уникальный код
3. Каждое бизнес событие должно иметь флаг - является оно ошибкой или нет

## Логирование на уровне систем
### Shop API
- **Логи уровня INFO:**
    - ID заказа.
    - Состояние обработки заказа.
    - Время выполнения запросов.
- **Ошибки:**
    - HTTP 500 ошибки.
    - Проблемы с внешними зависимостями (например, RabbitMQ или база данных).

### MES API
- **Логи уровня INFO:**
    - Состояние выполнения заказов.
    - Метрики времени расчёта стоимости заказов.
- **Ошибки:**
    - Проблемы с RabbitMQ.
    - Ошибки в бизнес-логике.

### RabbitMQ
- **Логи уровня INFO:**
    - Общее количество сообщений.
    - Сообщения, ушедшие в dead-letter queue.
- **Ошибки:**
    - Перегрузка очередей.
    - Потерянные сообщения.

### CRM API
- **Логи уровня INFO:**
    - Обновления заказов.
    - Состояние обработки запросов.
- **Ошибки:**
    - Временные задержки и ошибки связи.

---

## Мотивация
Логирование позволяет:
1. Быстрее находить и устранять причины проблем.
2. Снизить нагрузку на команду поддержки.
3. Улучшить прозрачность для бизнеса, особенно в критических сценариях.
4. Ускорить время реакции на инциденты благодаря централизованной системе сбора логов.

---

## Предлагаемое решение
### Технологический стек
- **ELK-стек (Elasticsearch, Logstash, Kibana):**
    - Elasticsearch для индексации и хранения логов.
    - Logstash для сбора и нормализации данных.
    - Kibana для визуализации и анализа логов.
- **Filebeat:** для передачи логов из контейнеров в Logstash.
- **Graylog:** для маршрутизации логов и настройки алертинга.

### Хранение данных
- Логи будут храниться в Elasticsearch с разделением по индексу на каждую подсистему.
- Время хранения: 30 дней для оперативного анализа, архивирование на 1 год для долгосрочного хранения.

---

## Меры безопасности
1. **Аутентификация и авторизация:**
    - Доступ к логам только у сотрудников с ролью "Поддержка".
2. **Шифрование данных:**
    - Все логи хранятся в зашифрованном виде.
3. **Контроль доступа:**
    - Разграничение прав доступа между разработчиками и администраторами.

---

## Дополнительные мероприятия
1. **Алертинг:**
    - Настройка триггеров в Graylog для HTTP 500 ошибок и задержек обработки заказов.
2. **Анализ аномалий:**
    - Внедрение machine learning-моделей для автоматического поиска отклонений.
3. **Автоматизация:**
    - Интеграция с CI/CD для автоматического добавления логов при изменении функционала.

---

## План действий
1. Развернуть инфраструктуру для ELK-стека.
2. Настроить Filebeat для каждого компонента системы.
3. Определить шаблоны индексации в Elasticsearch.
4. Внедрить политики доступа и шифрования.
5. Настроить алертинг в Graylog.
6. Протестировать работоспособность логирования в тестовой среде.
7. Постепенно внедрить решение в продакшн.

---

## Ожидаемые результаты
- Сокращение времени поиска и устранения проблем на 50%.
- Повышение прозрачности системы для бизнеса.
- Снижение нагрузки на поддержку благодаря предиктивным алертам.