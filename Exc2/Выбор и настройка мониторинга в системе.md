# Мотивация к выбору настроек и метрик мониторинга

### Общая мотивация:
Мониторинг — это основа для обеспечения стабильности и предсказуемости работы системы. Он помогает:
1. Выявлять узкие места и аномалии в производительности.
2. Ускорять диагностику и устранение инцидентов.
3. Предотвращать сбои за счёт проактивного подхода.
4. Обеспечивать прозрачность для бизнеса, позволяя оценивать состояние системы в реальном времени.

**Основной принцип мониторинга в данной системе:** Сфокусироваться на критически важных компонентах, таких как API, RabbitMQ, MES и база данных, чтобы минимизировать влияние проблем на пользователей, а также дополнительно учитывать бизнесовые аспекты.

---

## Мотивация через призму проблем приложения

### Основные проблемы:

1. **Долгий срок выполнения заказов (Shop API, CRM API, MES API):**
   - **Связь с мониторингом:**
      - Метрики RPS и latency позволяют определить, на каком этапе возникают задержки.
      - HTTP-коды (500, 200) помогают понять, насколько успешны запросы.
   - **Почему?** Мониторинг обеспечит контроль за производительностью API, что напрямую влияет на клиентский опыт.

2. **Низкая производительность RabbitMQ:**
   - **Связь с мониторингом:**
      - Метрики dead-letter exchange и сообщений в очереди позволяют оценить нагрузку на RabbitMQ.
   - **Почему?** Обнаружение и устранение перегрузки RabbitMQ минимизирует сбои в обработке заказов.

3. **Отсутствие масштабируемости базы данных:**
   - **Связь с мониторингом:**
      - Метрики использования CPU, памяти и подключений к базе данных позволяют определить насыщенность ресурсов.
   - **Почему?** Эти данные помогут своевременно увеличить мощность базы данных и избежать задержек.

4. **Недостаточная прозрачность бизнес-метрик:**
   - **Связь с мониторингом:**
      - Метрики вроде Conversion Rate и DAU/MAU помогут понять, как изменения в системе влияют на бизнес.
   - **Почему?** Бизнес-ориентированные метрики позволяют принимать решения, направленные на увеличение дохода и клиентской базы.

---

## Выбранные метрики и их обоснование

### Бизнес-метрики:

1. **Conversion rate:** Количество успешно завершённых заказов.
   - **Почему?** Помогает понять, насколько эффективно работают пользовательские интерфейсы и процессы оформления заказа.
2. **Cost Per Sale:** Средняя сумма одной сделки.
   - **Почему?** Важна для анализа рентабельности продаж.
3. **Customer lifetime value:** Средний доход от одного клиента.
   - **Почему?** Позволяет оценить долгосрочную ценность клиента.
4. **DAU/MAU:** Количество уникальных пользователей в день/месяц.
   - **Почему?** Показывает активность и вовлечённость пользователей.
5. **New Users:** Количество новых пользователей (например, за месяц).
   - **Почему?** Помогает оценить эффективность маркетинговых кампаний.
6. **Среднее время выполнения заказа:**
   - **Почему?** Влияет на уровень удовлетворённости клиентов.

---

### Метрики API:

1. **RPS (Requests per Second):**
   - **Почему?** Измеряет текущую нагрузку на API, помогает определить узкие места.
2. **Latency (Response Time):**
   - **Почему?** Позволяет понять, где происходят задержки в обработке запросов.
3. **HTTP-коды (200, 500):**
   - **Почему?** Показывают, сколько запросов успешно обработано и сколько завершились ошибкой.

---

### RabbitMQ и в целом про взаимодействия между сервисами:

1. **Dead-letter exchange:**
   - **Почему?** Обнаруживает сообщения, которые не могут быть обработаны, сигнализируя о сбоях.
2. **Количество сообщений в очереди (in-flight):**
   - **Почему?** Показывает загруженность очередей и потенциальные узкие места.

---

### Общесистемные метрики:

1. **CPU Utilization:**
   - **Почему?** Контролирует использование процессора базы данных.
2. **Memory Utilization:**
   - **Почему?** Показывает, насколько эффективно используются ресурсы памяти.
3. **Количество подключений к БД:**
   - **Почему?** Помогает выявить перегрузку базы данных.

---

### Вывод

1. Метрики выбраны таким образом, чтобы покрыть как технические аспекты (стабильность, производительность), так и бизнес-цели (эффективность продаж, рост клиентской базы).
2. Использование мониторинга позволит:
   - Реагировать на проблемы в режиме реального времени.
   - Прогнозировать и предотвращать сбои.
   - Поддерживать стабильную и прозрачную работу системы.

# План действий для реализации мониторинга и метрик

Для достижения целевого уровня мониторинга и наблюдаемости с учетом указанных бизнес- и технических метрик, предлагается следующий план действий:

---

## 1. Анализ текущей системы

1. **Сбор требований:**
   - Провести встречи с командами DevOps, разработки, бизнеса и QA для определения ключевых метрик и областей мониторинга.
   - Уточнить бизнес-метрики с продукт-менеджером (например, Conversion rate, DAU/MAU, Cost Per Sale).

2. **Аудит текущих инструментов:**
   - Оценить, какие метрики уже собираются (например, системные метрики RabbitMQ, базы данных).
   - Выявить пробелы в наблюдаемости (например, отсутствие трейсинга или недостаток бизнес-метрик).

---

## 2. Выбор и настройка инструментов

### 2.1. Инструменты для мониторинга
- **Prometheus + Grafana:**
   - Использовать для сбора и визуализации технических метрик (RPS, latency, HTTP-коды, утилизация CPU/памяти).
   - Настроить алерты для превышения критических порогов.

- **OpenTelemetry:**
   - Настроить трассировку бизнес-сущностей (например, заказов) для детального анализа их прохождения через компоненты системы (Shop API, CRM API, MES API).

- **ELK-стек (Elasticsearch, Logstash, Kibana):**
   - Централизовать сбор логов всех подсистем.
   - Добавить идентификатор заказа в логи для упрощения диагностики.

### 2.2. Настройка метрик
- Добавить экспорт метрик для API (Shop API, CRM API, MES API) через стандартные библиотеки (например, Micrometer для Spring Boot).
- Включить сбор метрик RabbitMQ (dead-letter exchange, in-flight messages) и базы данных (CPU, память, подключения).

---

## 3. Внедрение бизнес-метрик

1. **Conversion Rate:**
   - Настроить вычисление процента завершенных заказов через Shop API и CRM API.
   - Визуализировать в Grafana дашбордах.

2. **Среднее время выполнения заказа:**
   - Рассчитать на основе данных трассировки OpenTelemetry.
   - Отображать среднее время для разных этапов обработки заказа.

3. **DAU/MAU и New Users:**
   - Интегрировать данные аналитики с источников (например, Google Analytics или Yandex Metrica) в Grafana.

---

## 4. Создание дашбордов и алертов

1. **Технические дашборды:**
   - Дашборды с метриками RPS, latency, CPU/memory utilization.
   - Разделить по компонентам (Shop API, CRM API, MES API, RabbitMQ, база данных).

2. **Бизнес-дашборды:**
   - Включить Conversion Rate, DAU/MAU, New Users, среднее время выполнения заказов.
   - Подготовить отчёты для бизнеса (ежедневные/еженедельные).

3. **Настройка алертов:**
   - Настроить уведомления в Slack/Email на основе:
      - RPS превышает допустимые значения.
      - Утилизация CPU > 80%.
      - HTTP 500 превышает 5% от всех запросов.

---

## 5. Тестирование и доработка

1. **Проверка корректности метрик:**
   - Тестировать правильность подсчёта метрик (например, соответствие RPS реальной нагрузке).
   - Проверить, что трассировка заказов покрывает все этапы прохождения через систему.

2. **Нагрузочное тестирование:**
   - Провести тесты для проверки системы под высокой нагрузкой.
   - Убедиться, что мониторинг адекватно реагирует на аномалии.

3. **Адаптация алертов:**
   - Настроить пороговые значения алертов на основе тестов и реальной нагрузки.

---

## 6. Обучение команды и внедрение в эксплуатацию

1. **Обучение сотрудников:**
   - Провести воркшопы для команд по использованию инструментов мониторинга (Prometheus, Grafana, ELK).
   - Обучить инженеров интерпретации бизнес-метрик.

2. **Пилотный запуск:**
   - Развернуть мониторинг в тестовой среде, проверить стабильность работы.
   - Постепенно внедрить в production.

3. **Обратная связь:**
   - Собирать фидбек от технических и бизнес-команд.
   - Доработать дашборды и метрики на основе обратной связи.

---

## 7. Итоговый результат

1. **Для технической команды:**
   - Увеличение прозрачности работы системы.
   - Быстрая диагностика и устранение инцидентов.
   - Снижение времени простоя сервисов.

2. **Для бизнеса:**
   - Увеличение лояльности клиентов за счёт быстрого реагирования на проблемы.
   - Рост ключевых показателей (Conversion Rate, DAU/MAU).
   - Прозрачность данных для принятия решений.

---

Этот план обеспечивает систематический подход к внедрению мониторинга и достижению целевых бизнес- и технических метрик.